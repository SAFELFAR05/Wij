<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DramaBox Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: black; color: white; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .video-container { flex: 1; position: relative; display: flex; align-items: center; justify-content: center; background: black; }
        video { max-height: 100%; width: auto; max-width: 100%; }
        .controls-overlay { position: absolute; top: 0; left: 0; width: 100%; padding: 20px; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); }
        .episodes-sidebar { width: 300px; background: #141414; border-left: 1px solid #333; display: flex; flex-direction: column; }
        .episodes-list { flex: 1; overflow-y: auto; padding: 10px; }
    </style>
</head>
<body>
    <div class="flex h-full">
        <!-- Main Content -->
        <div class="flex-1 flex flex-col relative bg-black">
            <!-- Header -->
            <div class="controls-overlay z-10 flex items-center justify-between">
                <a href="/" class="flex items-center space-x-2 text-white hover:text-gray-300 transition">
                    <i class="fas fa-arrow-left text-2xl"></i>
                    <span class="text-xl font-bold">Kembali ke Beranda</span>
                </a>
                <div class="text-center">
                    <h1 id="drama-name" class="text-xl font-bold">Loading...</h1>
                    <p id="episode-name" class="text-sm text-gray-400">Episode 1</p>
                </div>
                <div class="w-10"></div> <!-- Spacer -->
            </div>

            <!-- Video Area -->
            <div class="video-container">
                <video id="main-video" controls autoplay playsinline class="shadow-2xl">
                    Your browser does not support the video tag.
                </video>
                <div id="video-loading" class="absolute inset-0 flex items-center justify-center bg-black/50 z-20">
                    <i class="fas fa-spinner fa-spin text-5xl text-red-600"></i>
                </div>
            </div>
        </div>

        <!-- Episodes Sidebar -->
        <div class="episodes-sidebar hidden md:flex">
            <div class="p-4 border-b border-gray-800">
                <h2 class="text-lg font-bold">Daftar Episode</h2>
            </div>
            <div id="episodes-list" class="episodes-list space-y-2">
                <!-- Episodes injected here -->
            </div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const bookId = urlParams.get('bookId');
        const episode = urlParams.get('episode') || 1;

        async function initPlayer() {
            if (!bookId) return window.location.href = '/';

            try {
                // Fetch Stream Link
                const streamRes = await fetch(`/api/stream?bookId=${bookId}&episode=${episode}`);
                const streamData = await streamRes.json();
                
                if (streamData.status === "success") {
                    const videoUrl = streamData.data.chapter.video.mp4;
                    const videoElement = document.getElementById('main-video');
                    videoElement.src = videoUrl;
                    document.getElementById('video-loading').style.display = 'none';
                    document.getElementById('episode-name').innerText = `Episode ${episode}`;
                }

                // Fetch Details for Sidebar & Title
                const detailRes = await fetch(`/api/dramas/${bookId}`);
                const detailData = await detailRes.json();
                
                if (detailData.success) {
                    const drama = detailData.data.drama;
                    const chapters = detailData.data.chapters;
                    
                    document.getElementById('drama-name').innerText = drama.bookName;
                    document.title = `${drama.bookName} - Episode ${episode}`;

                    const list = document.getElementById('episodes-list');
                    list.innerHTML = chapters.map(ch => `
                        <a href="/player.html?bookId=${bookId}&episode=${ch.index + 1}" 
                           class="flex items-center space-x-3 p-3 rounded hover:bg-[#2f2f2f] transition ${ch.index + 1 == episode ? 'bg-[#2f2f2f] border-l-4 border-red-600' : ''}">
                            <div class="w-8 h-8 flex items-center justify-center bg-black/50 rounded-full text-xs">
                                ${ch.index + 1}
                            </div>
                            <span class="text-sm">Episode ${ch.index + 1}</span>
                        </a>
                    `).join('');
                }
            } catch (err) {
                console.error('Player init failed:', err);
            }
        }

        initPlayer();
    </script>
</body>
</html>
