<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELFARBOX - Detail Drama [v1.2.1]</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #141414; color: white; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; }
        .hero-gradient { background: linear-gradient(to top, #141414 0%, rgba(20,20,20,0) 50%, rgba(20,20,20,0.5) 100%); }
        .video-container { 
            position: relative; 
            width: 100%; 
            background: black;
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 16/9;
        }
        #custom-video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .player-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.5);
            cursor: pointer;
            transition: opacity 0.3s;
        }
        .player-overlay:hover { opacity: 0.8; }
        .fullscreen-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.6);
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            z-index: 10;
        }
    </style>
</head>
<body>
    <nav class="fixed top-0 w-full z-50 p-4 bg-gradient-to-b from-black/80 to-transparent flex justify-between items-center">
        <a href="/" class="flex items-center space-x-2 text-white hover:text-gray-300 transition">
            <i class="fas fa-arrow-left text-2xl"></i>
            <span class="text-xl font-bold">Kembali</span>
        </a>
        <h1 class="text-red-600 text-xl md:text-2xl font-bold tracking-tighter uppercase cursor-pointer" onclick="window.location.href='/'">ELFAR<span class="italic">BOX</span></h1>
    </nav>

    <div id="detail-content" class="min-h-screen">
        <div class="flex items-center justify-center h-screen">
            <i class="fas fa-spinner fa-spin text-5xl text-red-600"></i>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const bookId = urlParams.get('id');
        const episode = urlParams.get('episode') || 1;

        async function fetchWithProxy(url) {
            try {
                // Using corsproxy.io as an alternative to allorigins
                const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                return data;
            } catch (err) {
                console.error('Proxy fetch failed, trying alternative:', err);
                // Fallback to allorigins if corsproxy fails
                try {
                    const altProxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                    const altResponse = await fetch(altProxyUrl);
                    const altData = await altResponse.json();
                    return JSON.parse(altData.contents);
                } catch (altErr) {
                    console.error('All proxies failed:', altErr);
                    throw altErr;
                }
            }
        }

        async function fetchDetail() {
            if (!bookId) return window.location.href = '/';
            
            try {
                // Using backend API
                const response = await fetch(`/api/dramas/${bookId}`);
                const result = await response.json();
                
                if (result.success) {
                    const d = result.data.drama;
                    const chapters = result.data.chapters;
                    
                    document.title = `${d.bookName} - ELFARBOX [v1.2.1]`;

                    // Fetch stream for current episode via backend
                    let videoUrl = '';
                    try {
                        const streamResponse = await fetch(`/api/stream?bookId=${bookId}&episode=${episode}`);
                        const streamData = await streamResponse.json();
                        videoUrl = streamData.status === "success" ? streamData.data.chapter.video.mp4 : '';
                    } catch (e) {
                        console.error('Failed to fetch stream:', e);
                    }
                    const posterUrl = d.coverWap || d.cover;
                    
                    const currentEp = parseInt(episode);
                    const totalEps = d.chapterCount;
                    const hasPrev = currentEp > 1;
                    const hasNext = currentEp < totalEps;

                    document.getElementById('detail-content').innerHTML = `
                        <!-- Player Section -->
                        <div class="pt-16 md:pt-20 px-0 md:px-12 max-w-6xl mx-auto">
                            <div class="video-container shadow-2xl group !rounded-none md:!rounded-lg">
                                <video id="custom-video" ${videoUrl ? 'src="'+videoUrl+'"' : ''} poster="${posterUrl}" controls controlsList="nodownload" oncontextmenu="return false;" playsinline class="w-full h-full"></video>
                                ${!videoUrl ? '<div class="absolute inset-0 flex items-center justify-center bg-gray-900"><p>Gagal memuat video</p></div>' : ''}
                                <div class="fullscreen-btn hover:scale-110 transition" onclick="toggleFullscreen()">
                                    <i class="fas fa-expand text-white text-lg"></i>
                                </div>
                            </div>
                            
                            <!-- Episode Navigation Buttons -->
                            <div class="flex justify-between items-center mt-4 px-4 md:px-0">
                                <button onclick="window.location.href='/detail.html?id=${bookId}&episode=${currentEp - 1}'" 
                                        class="flex items-center space-x-2 px-6 py-2 bg-[#2f2f2f] hover:bg-[#3f3f3f] rounded-full transition ${!hasPrev ? 'opacity-0 pointer-events-none' : ''}"
                                        data-testid="button-prev-episode">
                                    <i class="fas fa-chevron-left"></i>
                                    <span>Sebelumnya</span>
                                </button>
                                <button onclick="window.location.href='/detail.html?id=${bookId}&episode=${currentEp + 1}'" 
                                        class="flex items-center space-x-2 px-6 py-2 bg-red-600 hover:bg-red-700 rounded-full transition ${!hasNext ? 'opacity-0 pointer-events-none' : ''}"
                                        data-testid="button-next-episode">
                                    <span>Berikutnya</span>
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Info Section -->
                        <div class="px-4 md:px-12 py-6 md:py-8 max-w-6xl mx-auto">
                            <div class="flex flex-col md:flex-row md:items-end justify-between gap-4 md:gap-6 mb-6 md:mb-8">
                                <div>
                                    <h1 class="text-2xl md:text-5xl font-bold mb-1 md:mb-2">${d.bookName}</h1>
                                    <p class="text-red-600 font-bold text-base md:text-lg">Episode ${episode}</p>
                                </div>
                                <div class="flex items-center space-x-3 md:space-x-4 text-green-500 font-bold text-xs md:text-base">
                                    <span>98% Match</span>
                                    <span class="text-gray-400 font-normal">Total: ${d.chapterCount} Eps</span>
                                    <span class="border border-gray-600 px-1 text-[10px] md:text-xs text-gray-400 font-normal">HD</span>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
                                <div class="lg:col-span-2">
                                    <h3 class="text-xl font-bold mb-4">Sinopsis</h3>
                                    <p class="text-base md:text-lg leading-relaxed text-gray-300 mb-8 md:mb-12">${d.introduction}</p>
                                    
                                    <h3 class="text-xl md:text-2xl font-bold mb-4 md:mb-6 border-b border-gray-800 pb-2">Pilih Episode</h3>
                                    <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-2 md:gap-3">
                                        ${chapters.map(ch => {
                                            const isActive = (ch.index + 1) == episode;
                                            return `
                                                <a href="/detail.html?id=${bookId}&episode=${ch.index + 1}" 
                                                   class="py-2 md:py-4 rounded text-center transition border text-sm md:text-base ${isActive ? 'bg-red-600 border-red-600 text-white' : 'bg-[#2f2f2f] hover:bg-[#3f3f3f] border-transparent'}">
                                                    Eps ${ch.index + 1}
                                                </a>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                                
                                <div class="space-y-6 text-sm">
                                    <div class="bg-[#181818] p-6 rounded-lg border border-gray-800">
                                        <div class="mb-4">
                                            <span class="text-gray-500 block mb-1 uppercase tracking-wider text-xs font-bold">Pemeran</span>
                                            <p class="text-gray-200">${d.performerList.map(p => p.performerName).join(', ')}</p>
                                        </div>
                                        <div class="mb-4">
                                            <span class="text-gray-500 block mb-1 uppercase tracking-wider text-xs font-bold">Genre</span>
                                            <p class="text-gray-200">${d.typeTwoName}</p>
                                        </div>
                                        <div>
                                            <span class="text-gray-500 block mb-1 uppercase tracking-wider text-xs font-bold">Label</span>
                                            <div class="flex flex-wrap gap-2 mt-2">
                                                ${d.tags.map(tag => `<span class="bg-[#333] px-2 py-1 rounded text-[10px] text-gray-300">${tag}</span>`).join('')}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Recommendations Section -->
                        <div class="px-4 md:px-12 py-12 max-w-6xl mx-auto">
                            <h3 class="text-2xl font-bold mb-6 border-b border-gray-800 pb-2">Rekomendasi Untuk Anda</h3>
                            <div id="recommendation-list" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                                <div class="col-span-full text-center py-10">
                                    <i class="fas fa-spinner fa-spin text-2xl"></i>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Fetch recommendations via backend
                    fetch('/api/recommendations')
                        .then(res => res.json())
                        .then(recResult => {
                            if (recResult.success) {
                                const recContainer = document.getElementById('recommendation-list');
                                recContainer.innerHTML = recResult.data.map(rec => `
                                    <div onclick="window.location.href='/detail.html?id=${rec.bookId}'" class="movie-card transition-all duration-300 cursor-pointer group">
                                        <div class="relative overflow-hidden rounded-sm">
                                            <img src="${rec.coverWap}" alt="${rec.bookName}" class="w-full h-auto aspect-[2/3] object-cover transition-transform duration-300 group-hover:scale-110">
                                            ${rec.corner ? `<span class="absolute top-2 left-2 bg-red-600 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-sm">${rec.corner.name}</span>` : ''}
                                        </div>
                                        <p class="mt-2 text-sm font-medium line-clamp-1 group-hover:text-red-500 transition-colors">${rec.bookName}</p>
                                    </div>
                                `).join('');
                            }
                        });
                }
            } catch (err) {
                console.error('Fetch detail failed:', err);
                document.getElementById('detail-content').innerHTML = '<div class="p-20 text-center text-red-500">Gagal memuat konten.</div>';
            }
        }

        function toggleFullscreen() {
            const video = document.getElementById('custom-video');
            if (!video) return;
            
            if (video.requestFullscreen) {
                video.requestFullscreen();
            } else if (video.webkitRequestFullscreen) { /* Safari */
                video.webkitRequestFullscreen();
            } else if (video.msRequestFullscreen) { /* IE11 */
                video.msRequestFullscreen();
            } else if (video.webkitEnterFullscreen) { /* iOS */
                video.webkitEnterFullscreen();
            }
        }

        fetchDetail();
    </script>
</body>
</html>
